---
# ───────────────────────────────────────────────────────────────────
# Role: Jenkins — Install, Configure, and Harden Jenkins Master
# ───────────────────────────────────────────────────────────────────

# ─── 1. Add Jenkins Repository ───────────────────────────────────
- name: Download Jenkins Repository File
  get_url:
    url: https://pkg.jenkins.io/redhat-stable/jenkins.repo
    dest: /etc/yum.repos.d/jenkins.repo

- name: Import Jenkins GPG Key
  rpm_key:
    key: https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
    state: present

- name: Install Jenkins
  dnf:
    name: jenkins
    state: present

# ─── 2. Configure Jenkins to Run as ec2-user ─────────────────────
- name: Create Jenkins Service Override Directory
  file:
    path: /etc/systemd/system/jenkins.service.d
    state: directory
    mode: '0755'

- name: Deploy Jenkins Service Override (Run as ec2-user)
  copy:
    dest: /etc/systemd/system/jenkins.service.d/override.conf
    content: |
      [Service]
      User=ec2-user
      Group=ec2-user
      Environment="JENKINS_HOME=/var/lib/jenkins"
      ExecStart=
      ExecStart=/usr/bin/jenkins
    mode: '0644'
  notify: Reload Systemd

# ─── 3. Prepare Jenkins Directories ──────────────────────────────
- name: Create Jenkins Directories
  file:
    path: "{{ item }}"
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'
  loop:
    - /var/lib/jenkins
    - /var/lib/jenkins/plugins
    - /var/cache/jenkins
    - /var/log/jenkins

# ─── 4. Install Jenkins Plugins ──────────────────────────────────
- name: Install Jenkins Plugins via CLI
  command: >
    jenkins-plugin-cli --plugins
    workflow-aggregator
    git
    github-branch-source
    docker-workflow
    sonar
    maven-plugin
    temurin-installer
    credentials-binding
    dependency-check-jenkins-plugin
    aws-credentials
    pipeline-utility-steps
  become_user: ec2-user
  args:
    creates: /var/lib/jenkins/plugins/git.jpi

# ─── 5. Configure Java Environment ──────────────────────────────
- name: Set JAVA_HOME in ec2-user Profile
  lineinfile:
    path: /home/ec2-user/.bashrc
    line: "{{ item }}"
    create: yes
  loop:
    - 'export JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto'
    - 'export PATH=$PATH:$HOME/bin:$JAVA_HOME/bin'

# ─── 6. Generate SSH Key for ec2-user ────────────────────────────
- name: Ensure .ssh Directory Exists
  file:
    path: /home/ec2-user/.ssh
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0700'

- name: Generate SSH Key Pair for ec2-user
  openssh_keypair:
    path: /home/ec2-user/.ssh/id_rsa
    type: rsa
    size: 4096
    owner: ec2-user
    group: ec2-user

- name: Ensure known_hosts Exists
  file:
    path: /home/ec2-user/.ssh/known_hosts
    state: touch
    owner: ec2-user
    group: ec2-user
    mode: '0600'
  changed_when: false

# ─── 7. Optimize /tmp for Large Builds ──────────────────────────
- name: Mount tmpfs for /tmp (Build Performance)
  mount:
    path: /tmp
    src: tmpfs
    fstype: tmpfs
    opts: "defaults,size=1500M"
    state: mounted

# ─── 8. Start Jenkins ────────────────────────────────────────────
- name: Enable and Start Jenkins Service
  systemd:
    name: jenkins
    state: started
    enabled: yes
    daemon_reload: yes

- name: Wait for Jenkins to Initialize
  wait_for:
    port: 8080
    delay: 10
    timeout: 120

# ─── 9. Retrieve Admin Password ─────────────────────────────────
- name: Read Jenkins Initial Admin Password
  slurp:
    src: /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_admin_password
  ignore_errors: yes

- name: Read ec2-user SSH Public Key
  slurp:
    src: /home/ec2-user/.ssh/id_rsa.pub
  register: ec2_user_pubkey

- name: Display Jenkins Setup Info
  debug:
    msg:
      - "════════════════════════════════════════════════"
      - "✅ Jenkins Master Configured Successfully!"
      - "════════════════════════════════════════════════"
      - "Admin Password: {{ (jenkins_admin_password.content | b64decode | trim) if jenkins_admin_password is succeeded else 'N/A' }}"
      - "SSH Public Key: {{ ec2_user_pubkey.content | b64decode | trim }}"
      - "════════════════════════════════════════════════"
