---
# ───────────────────────────────────────────────────────────────────
# Role: Jenkins — Install, Configure, and Harden Jenkins Master
# ───────────────────────────────────────────────────────────────────

# ─── 0. Wait for System Readiness ───────────────────────────────
- name: Wait for Cloud-Init to finish (Prevents dnf lock issues)
  command: cloud-init status --wait
  changed_when: false

# ─── 1. Add Jenkins Repository ───────────────────────────────────
- name: Download Jenkins Repository File
  get_url:
    url: https://pkg.jenkins.io/redhat-stable/jenkins.repo
    dest: /etc/yum.repos.d/jenkins.repo
    mode: '0644'

- name: Import Jenkins GPG Key
  command: rpm --import https://pkg.jenkins.io/redhat-stable/jenkins.io-2023.key
  register: gpg_import
  failed_when: gpg_import.rc != 0 and 'already installed' not in gpg_import.stderr

- name: Update dnf cache again
  dnf:
    update_cache: yes

- name: Install Jenkins
  dnf:
    name: jenkins
    state: present

# ─── 2. Configure Jenkins to Run as ec2-user ─────────────────────
- name: Create Jenkins Service Override Directory
  file:
    path: /etc/systemd/system/jenkins.service.d
    state: directory
    mode: '0755'

- name: Deploy Jenkins Service Override (Run as ec2-user)
  copy:
    dest: /etc/systemd/system/jenkins.service.d/override.conf
    content: |
      [Service]
      User=ec2-user
      Group=ec2-user
      # Force a larger heap and specific Java path if needed
      Environment="JENKINS_HOME=/var/lib/jenkins"
      # ExecStart= must be empty before being redefined in systemd
      ExecStart=
      ExecStart=/usr/bin/jenkins
    mode: '0644'
  notify: Reload Systemd

- name: Flush handlers (Force systemd reload now)
  meta: flush_handlers

# ─── 3. Prepare Jenkins Directories ──────────────────────────────
- name: Create Jenkins Directories
  file:
    path: "{{ item }}"
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0755'
  loop:
    - /var/lib/jenkins
    - /var/lib/jenkins/plugins
    - /var/cache/jenkins
    - /var/log/jenkins

# ─── 4. Install Jenkins Plugin Manager CLI ───────────────────────
# The 'jenkins-plugin-cli' is not a system package, we download the jar
- name: Download Jenkins Plugin Manager Tool
  get_url:
    url: https://github.com/jenkinsci/plugin-installation-manager-tool/releases/download/2.12.13/jenkins-plugin-manager-2.12.13.jar
    dest: /opt/jenkins-plugin-manager.jar
    mode: '0644'

- name: Install Jenkins Plugins via Manager Tool
  command: >
    java -jar /opt/jenkins-plugin-manager.jar
    --war /usr/share/java/jenkins.war
    --plugin-download-directory /var/lib/jenkins/plugins
    --plugins
    workflow-aggregator:596.v8c21da_02283a_
    git:5.2.1
    github-branch-source:1767.va_7d01b_c729f9
    docker-workflow:572.v950f58993843
    sonar:2.16.1
    maven-plugin:3.23
    credentials-binding:642.v781769450dca_
    aws-credentials:218.v1b_cb_a_9213550
    pipeline-utility-steps:2.16.0
  become_user: ec2-user
  args:
    creates: /var/lib/jenkins/plugins/git.jpi

# ─── 5. Configure Java Environment ──────────────────────────────
- name: Set JAVA_HOME in ec2-user Profile
  lineinfile:
    path: /home/ec2-user/.bashrc
    line: "{{ item }}"
    create: yes
  loop:
    - 'export JAVA_HOME=/usr/lib/jvm/java-21-amazon-corretto'
    - 'export PATH=$PATH:$HOME/bin:$JAVA_HOME/bin'

# ─── 6. Generate SSH Key for ec2-user ────────────────────────────
- name: Ensure .ssh Directory Exists
  file:
    path: /home/ec2-user/.ssh
    state: directory
    owner: ec2-user
    group: ec2-user
    mode: '0700'

- name: Generate SSH Key Pair for ec2-user
  openssh_keypair:
    path: /home/ec2-user/.ssh/id_rsa
    type: rsa
    size: 4096
    owner: ec2-user
    group: ec2-user

- name: Ensure known_hosts Exists
  file:
    path: /home/ec2-user/.ssh/known_hosts
    state: touch
    owner: ec2-user
    group: ec2-user
    mode: '0600'
  changed_when: false

# ─── 7. Optimize /tmp for Large Builds ──────────────────────────
- name: Mount tmpfs for /tmp (Build Performance)
  mount:
    path: /tmp
    src: tmpfs
    fstype: tmpfs
    opts: "defaults,size=1500M"
    state: mounted

# ─── 8. Start Jenkins ────────────────────────────────────────────
- name: Enable and Start Jenkins Service
  systemd:
    name: jenkins
    state: started
    enabled: yes

- name: Wait for Jenkins to Initialize
  wait_for:
    port: 8080
    delay: 15
    timeout: 300

# ─── 9. Retrieve Admin Password ─────────────────────────────────
- name: Read Jenkins Initial Admin Password
  slurp:
    src: /var/lib/jenkins/secrets/initialAdminPassword
  register: jenkins_admin_password
  ignore_errors: true

- name: Read ec2-user SSH Public Key
  slurp:
    src: /home/ec2-user/.ssh/id_rsa.pub
  register: ec2_user_pubkey

- name: Display Jenkins Setup Info
  debug:
    msg:
      - "════════════════════════════════════════════════"
      - "✅ Jenkins Master Configured Successfully!"
      - "════════════════════════════════════════════════"
      - "Admin Password: {{ (jenkins_admin_password.content | b64decode | trim) if (jenkins_admin_password is succeeded and jenkins_admin_password.content is defined) else 'N/A' }}"
      - "SSH Public Key: {{ ec2_user_pubkey.content | b64decode | trim }}"
      - "════════════════════════════════════════════════"
