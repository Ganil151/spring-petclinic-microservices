- name: Install dependencies (jq, python3-pip)
  dnf:
    name: 
      - jq
      - python3-pip
    state: present

- name: Get Latest Trivy Release JSON
  uri:
    url: https://api.github.com/repos/aquasecurity/trivy/releases/latest
    return_content: yes
  register: trivy_release

- name: Set Trivy Version and Arch Facts
  set_fact:
    trivy_ver: "{{ trivy_release.json.tag_name | regex_replace('^v', '') }}"
    trivy_arch: "{{ '64bit' if ansible_facts['architecture'] == 'x86_64' else 'ARM64' }}"

- name: Install Trivy RPM natively
  dnf:
    name: "https://github.com/aquasecurity/trivy/releases/download/v{{ trivy_ver }}/trivy_{{ trivy_ver }}_Linux-{{ trivy_arch }}.rpm"
    state: present
    disable_gpg_check: yes

- name: Install Checkov in a Virtual Environment (Prevents system package conflicts)
  pip:
    name: checkov
    state: present
    virtualenv: /opt/checkov-venv
    virtualenv_command: /usr/bin/python3 -m venv

- name: Create symlink for Checkov
  file:
    src: /opt/checkov-venv/bin/checkov
    dest: /usr/local/bin/checkov
    state: link

- name: Verify Trivy Installation
  command: trivy --version
  register: trivy_version
  changed_when: false

- name: Verify Checkov Installation
  command: /usr/local/bin/checkov --version
  register: checkov_version
  changed_when: false

- name: Display Security Tool Versions
  debug:
    msg:
      - "Trivy:   {{ trivy_version.stdout_lines[0] }}"
      - "Checkov: {{ checkov_version.stdout }}"
