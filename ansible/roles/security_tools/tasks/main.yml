---
- name: Install dependencies (jq)
  dnf:
    name: jq
    state: present

- name: Install Trivy RPM
  shell: |
    TRIVY_VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | jq -r .tag_name | sed 's/v//')
    TRIVY_ARCH={{ '64bit' if ansible_architecture == 'x86_64' else 'ARM64' }}
    dnf install -y "https://github.com/aquasecurity/trivy/releases/download/v${TRIVY_VERSION}/trivy_${TRIVY_VERSION}_Linux-${TRIVY_ARCH}.rpm"
  args:
    creates: /usr/bin/trivy

- name: Install Checkov (IaC Scanner)
  pip:
    name: checkov
    state: present
    executable: pip3

- name: Verify Trivy Installation
  command: trivy --version
  register: trivy_version
  changed_when: false

- name: Verify Checkov Installation
  command: checkov --version
  register: checkov_version
  changed_when: false

- name: Display Security Tool Versions
  debug:
    msg:
      - "Trivy:   {{ trivy_version.stdout_lines[0] }}"
      - "Checkov: {{ checkov_version.stdout }}"
