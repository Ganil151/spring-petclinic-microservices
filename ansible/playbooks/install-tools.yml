---
# ───────────────────────────────────────────────────────────────────
# Playbook: Install & Configure Spring PetClinic Infrastructure
# ───────────────────────────────────────────────────────────────────
# Inventory is auto-generated by Terraform (local_file.ansible_inventory)
# Run with: ansible-playbook playbooks/install-tools.yml
# ───────────────────────────────────────────────────────────────────

# ─── Play 1: Core Tools on ALL Nodes ─────────────────────────────
- name: Install Core Tools on All Nodes
  hosts: all_nodes
  gather_facts: true

  pre_tasks:
    - name: Display Target Node Info
      debug:
        msg: "Configuring {{ inventory_hostname }} ({{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }})"

    - name: Wait for SSH to become available
      wait_for_connection:
        delay: 5
        timeout: 120

    - name: Wait for Cloud-Init to finish (Prevents dnf lock issues)
      command: cloud-init status --wait
      changed_when: false

  roles:
    - java
    - docker
    - awscli

# ─── Play 2: Jenkins Master Configuration ────────────────────────
- name: Configure Jenkins Master
  hosts: jenkins_master
  gather_facts: false

  roles:
    - jenkins

# ─── Play 3: Build & Deploy Tools on Worker Nodes ────────────────
- name: Install Build & Deploy Tools on Worker Nodes
  hosts: build_agents
  gather_facts: false
  ignore_unreachable: true # Ensure we proceed to SonarQube even if worker nodes have issues

  roles:
    - maven
    - kubectl
    - helm
    - { role: eks_setup, ignore_errors: true }

# ─── Play 4: SonarQube Stack Deployment ──────────────────────────
- name: Deploy SonarQube Stack
  hosts: sonarqube
  gather_facts: false

  roles:
    - sonarqube

# ─── Play 5: DevSecOps Tools on CI/CD Nodes ──────────────────────
- name: Install DevSecOps Tools
  hosts: devops_tools
  gather_facts: false

  roles:
    - security_tools
